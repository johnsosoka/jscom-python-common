name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.1.0)'
        required: true
        type: string
      release_notes:
        description: 'Release notes (optional, will use CHANGELOG if empty)'
        required: false
        type: string

jobs:
  validate:
    name: Validate Release Prerequisites
    runs-on: ubuntu-latest
    outputs:
      checks_passed: ${{ steps.check_ci.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate version format
        run: |
          if ! echo "${{ inputs.version }}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Invalid version format. Must be semver (e.g., 1.2.3)"
            exit 1
          fi

      - name: Check if tag already exists
        run: |
          if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "Tag v${{ inputs.version }} already exists"
            exit 1
          fi

      - name: Verify CI checks passed on current commit
        id: check_ci
        uses: actions/github-script@v7
        with:
          script: |
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha
            });

            const relevantChecks = checks.check_runs.filter(check =>
              check.name.includes('Lint') ||
              check.name.includes('Type Check') ||
              check.name.includes('Test')
            );

            const allPassed = relevantChecks.every(check =>
              check.conclusion === 'success'
            );

            if (!allPassed) {
              core.setFailed('CI checks have not passed on this commit');
              return 'failed';
            }

            return 'passed';

  release:
    name: Create Release
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Update version in pyproject.toml
        run: |
          poetry version ${{ inputs.version }}

      - name: Extract CHANGELOG for this version
        id: changelog
        run: |
          VERSION=${{ inputs.version }}
          if [ -n "${{ inputs.release_notes }}" ]; then
            NOTES="${{ inputs.release_notes }}"
          else
            # Extract from CHANGELOG.md between [Unreleased] and previous version
            NOTES=$(awk '/## \[Unreleased\]/,/## \[/{if (!/## \[Unreleased\]/ && !/## \[/) print}' CHANGELOG.md || echo "See CHANGELOG.md for details")
          fi
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG.md with release date
        run: |
          DATE=$(date +%Y-%m-%d)
          sed -i "s/## \[Unreleased\]/## [Unreleased]\n\n## [${{ inputs.version }}] - $DATE/" CHANGELOG.md

      - name: Create release prep branch
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          BRANCH="release/v${{ inputs.version }}"

          # Check if release branch already exists and delete it
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "Release branch $BRANCH already exists. Deleting..."
            git push origin --delete "$BRANCH"
          fi

          git checkout -b "$BRANCH"
          git add pyproject.toml CHANGELOG.md
          git commit -m "Release v${{ inputs.version }}"
          git push origin "$BRANCH"

      - name: Create and merge release PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="release/v${{ inputs.version }}"
          PR_URL=$(gh pr create \
            --title "Release v${{ inputs.version }}" \
            --body "Automated release preparation for v${{ inputs.version }}" \
            --base main \
            --head "$BRANCH")

          echo "Created PR: $PR_URL"
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')

          # Wait for CI checks to complete
          echo "Waiting for CI checks to complete..."
          MAX_ATTEMPTS=60
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            # Get check status
            CHECK_STATUS=$(gh pr view "$PR_NUMBER" --json statusCheckRollup --jq '.statusCheckRollup[0].conclusion // "pending"')

            if [ "$CHECK_STATUS" = "SUCCESS" ] || [ "$CHECK_STATUS" = "NEUTRAL" ]; then
              echo "CI checks passed!"
              break
            elif [ "$CHECK_STATUS" = "FAILURE" ] || [ "$CHECK_STATUS" = "CANCELLED" ]; then
              echo "CI checks failed or were cancelled"
              exit 1
            fi

            echo "CI checks still running... (attempt $ATTEMPT/$MAX_ATTEMPTS)"
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
            echo "Timeout waiting for CI checks"
            exit 1
          fi

          # Merge using squash (repository setting)
          echo "Merging PR..."
          gh pr merge "$PR_NUMBER" --squash --delete-branch

      - name: Checkout main and create tag
        run: |
          # Pull the merged changes
          git checkout main
          git pull origin main
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ inputs.version }}
          release_name: v${{ inputs.version }}
          body: ${{ steps.changelog.outputs.notes }}
          draft: false
          prerelease: false
